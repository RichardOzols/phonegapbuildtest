<!DOCTYPE html>
<html>
    <head>
        <title>PGB Kitchen Sink</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
    </head>
    <body>
    	
		<div data-role="page" id="pageMediaRecord" data-cache="never">
			<script type="text/javascript" charset="utf-8">
				// http://docs.phonegap.com/en/2.3.0/cordova_media_media.md.html#Media
			
				$("#pageMediaRecord").bind('pageinit', function() {
					$("#btnStartRecord").off("click").on("click", function() {
						$("#btnStartRecord").button("disable");
						recordAudio();
						gaPlugin.trackEvent( nativePluginResultHandler, nativePluginErrorHandler, "Media", "Record", "Start", 1);
					});
				});
				
				// Record audio
				// 
				function recordAudio() {
					$("#playbackControls").hide();
					
					var src = "myrecording.mp3";
					var mediaRec = new Media(src, onSuccess, onError);

					// Record audio
					mediaRec.startRecord();

					// Stop recording after 10 sec
					var recTime = 0;
					var recInterval = setInterval(function() {
						recTime = recTime + 1;
						setAudioPosition(recTime + " sec");
						if (recTime >= 10) {
							clearInterval(recInterval);
							mediaRec.stopRecord();
							$("#playbackControls").fadeIn();
						}
					}, 1000);
				}

				// onSuccess Callback
				//
				function onSuccess() {
					alert("recordAudio():Audio Success");
				}

				// onError Callback 
				//
				function onError(error) {
					alert('code: '    + error.code    + '\n' + 
						  'message: ' + error.message + '\n');
				}

				// Set audio position
				// 
				function setAudioPosition(position) {
					$('#audio_position').html("Positoin: " + position);
				}
				
				// this here below is copied from media_play.html
				//
				// Audio player
				//
				var my_media = null;
				var mediaTimer = null;
				
				// Play audio
				//
				function playAudio(src) {
					// Create Media object from src
					my_media = new Media(src, onPlaySuccess, onPlayError);
					$("#btnPlay").button('disable');
					$("#btnStartRecord").button("enable");
					
					// Play audio
					my_media.play();

					// Update my_media position every second
					if (mediaTimer == null) {
						mediaTimer = setInterval(function() {
							// get my_media position
							my_media.getCurrentPosition(
								// success callback
								function(position) {
									if (position > -1) {
										setAudioPosition((position) + " sec");
									}
								},
								// error callback
								function(e) {
									alert("Error getting pos=" + e);
									setAudioPosition("Error: " + e);
								}
							);
						}, 1000);
					}
					
					// Get duration
					var counter = 0;
					var timerDur = setInterval(function() {
						counter = counter + 100;
						if (counter > 2000) {
							clearInterval(timerDur);
						}
						var dur = my_media.getDuration();
						if (dur > 0) {
							clearInterval(timerDur);
							$('#audio_duration').html("getDuration: " + (dur) + " sec");
						}
				   }, 100);
				   
				   gaPlugin.trackEvent( nativePluginResultHandler, nativePluginErrorHandler, "Media", "Play Recorded", src, 1);
				}

				// Pause audio
				// 
				function pauseAudio() {
					if (my_media) {
						my_media.pause();
						gaPlugin.trackEvent( nativePluginResultHandler, nativePluginErrorHandler, "Media", "Pause Recorded", $("#audio_position").text(), 1);
					}
				}

				// Stop audio
				// 
				function stopAudio() {
					if (my_media) {
						my_media.stop();
					}
					clearInterval(mediaTimer);
					mediaTimer = null;
				}
				
				// onSuccess Callback
				//
				function onPlaySuccess() {
					//alert("recordAudio():Audio Success");
					$("#btnPlay").button('enable');
				}

				// onError Callback 
				//
				function onPlayError(error) {
					alert('code: '    + error.code    + '\n' + 
						  'message: ' + error.message + '\n');
				}
			</script>
		
			<div data-role="header">
				<h1>Record Media</h1>
			</div><!-- /header -->

			<div data-role="content">
				<button data-role="button" id="btnStartRecord">Start Record</button>
				
				<p id="audio_position"></p>
				<p id="audio_duration"></p>
				
			</div>
			
			<div id="playbackControls" data-role="footer" data-position="fixed" style="display: none;">
				<div data-role="controlgroup" data-type="horizontal">					
					<a href="#" data-role="button" onclick="playAudio('myrecording.mp3');" id="btnPlay" data-icon="arrow-r">Play</a>
					<a href="#" data-role="button" data-theme="b" onclick="pauseAudio();" data-icon="bars">Pause</a>
					<a href="#" data-role="button" data-theme="c" onclick="stopAudio();" data-icon="delete">Stop</a>				
				</div>				
			</div><!-- /footer -->
		
		</div>
    </body>
</html>